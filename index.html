<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiverS - Магазин игровых предметов TimeZero</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a3a5f;
            --secondary-color: #00a8ff;
            --accent-color: #ff6b6b;
            --dark-bg: #0f1a2e;
            --light-bg: #1e2a47;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: #fff;
            background-image: url('https://images.unsplash.com/photo-1518709268805-4e9042af2176?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        
        .content-wrapper {
            background-color: rgba(15, 26, 46, 0.95);
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(26, 58, 95, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--secondary-color) !important;
        }
        
        .game-header {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                        url('https://images.unsplash.com/photo-1511512578047-dfb367046420?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            padding: 100px 0;
            text-align: center;
            margin-bottom: 50px;
            position: relative;
            overflow: hidden;
        }
        
        .game-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(0,168,255,0.2) 0%, rgba(255,107,107,0.2) 100%);
            z-index: 1;
        }
        
        .game-header .container {
            position: relative;
            z-index: 2;
        }
        
        .product-card {
            background: linear-gradient(145deg, rgba(30,42,71,0.9) 0%, rgba(26,58,95,0.9) 100%);
            border-radius: 12px;
            transition: all 0.3s ease;
            margin-bottom: 25px;
            border: 1px solid rgba(0, 168, 255, 0.2);
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 168, 255, 0.2);
            border-color: var(--secondary-color);
        }
        
        .product-img {
            height: 200px;
            width: 100%;
            object-fit: cover;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .category-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .price-tag {
            background: linear-gradient(45deg, var(--accent-color), #ff8e8e);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            display: inline-block;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }
        
        .btn-game {
            background: linear-gradient(45deg, var(--secondary-color), #0088cc);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-game:hover {
            background: linear-gradient(45deg, #0088cc, var(--secondary-color));
            color: white;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 168, 255, 0.4);
        }
        
        .cart-item {
            background: rgba(30,42,71,0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .currency-coin {
            color: #FFD700;
            margin-right: 5px;
            filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.5));
        }
        
        .category-filter {
            background: rgba(30,42,71,0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 168, 255, 0.2);
        }
        
        .category-btn {
            background: rgba(26, 58, 95, 0.7);
            color: #fff;
            border: 2px solid var(--secondary-color);
            margin: 5px;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s;
        }
        
        .category-btn:hover, .category-btn.active {
            background: var(--secondary-color);
            color: #000;
            font-weight: bold;
            transform: scale(1.05);
        }
        
        .cart-badge {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .empty-cart {
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-cart-icon {
            font-size: 4rem;
            color: var(--secondary-color);
            opacity: 0.5;
            margin-bottom: 20px;
        }
        
        .admin-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(45deg, var(--accent-color), #ff8e8e);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s;
        }
        
        .admin-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }
        
        .modal-content {
            background: linear-gradient(145deg, #1a3a5f, #0f1a2e);
            color: white;
            border: 2px solid var(--secondary-color);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .modal-footer {
            border-top: 1px solid var(--secondary-color);
        }
        
        .form-control {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--secondary-color);
            color: white;
        }
        
        .form-control:focus {
            background: rgba(255,255,255,0.15);
            border-color: var(--secondary-color);
            color: white;
            box-shadow: 0 0 0 0.25rem rgba(0, 168, 255, 0.25);
        }
        
        .form-label {
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .alert {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .admin-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: linear-gradient(145deg, #1a3a5f, #0f1a2e);
            z-index: 9998;
            transition: right 0.3s ease;
            border-left: 2px solid var(--secondary-color);
            overflow-y: auto;
        }
        
        .admin-panel.active {
            right: 0;
        }
        
        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9997;
            display: none;
        }
        
        .admin-overlay.active {
            display: block;
        }
        
        .telegram-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .telegram-status.connected {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }
        
        .telegram-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }
        
        .telegram-icon {
            font-size: 1.5rem;
            color: #0088cc;
        }
        
        .order-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInFromLeft 0.5s ease;
            max-width: 350px;
        }
        
        @keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .telegram-test-btn {
            background: linear-gradient(45deg, #0088cc, #006699);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .telegram-test-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 136, 204, 0.4);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-pending {
            background: #f39c12;
            color: #000;
        }
        
        .status-completed {
            background: #2ecc71;
            color: #fff;
        }
        
        .status-cancelled {
            background: #e74c3c;
            color: #fff;
        }
        
        .order-actions {
            display: flex;
            gap: 5px;
        }
        
        .order-card {
            background: rgba(30,42,71,0.8);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .order-card.completed {
            border-left-color: #2ecc71;
            opacity: 0.7;
        }
        
        .order-card.cancelled {
            border-left-color: #e74c3c;
            opacity: 0.7;
        }
        
        /* Новые стили для мульти-продавцов */
        .sellers-container {
            background: rgba(30,42,71,0.8);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .seller-card {
            background: rgba(26, 58, 95, 0.7);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--secondary-color);
            transition: all 0.3s;
        }
        
        .seller-card:hover {
            background: rgba(26, 58, 95, 0.9);
            transform: translateX(5px);
        }
        
        .seller-actions {
            display: flex;
            gap: 5px;
        }
        
        .seller-role-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .seller-role-admin {
            background: #e74c3c;
            color: white;
        }
        
        .seller-role-seller {
            background: #3498db;
            color: white;
        }
        
        .seller-test-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .seller-test-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.4);
        }
        
        .telegram-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .telegram-chip {
            background: rgba(0, 136, 204, 0.2);
            border: 1px solid rgba(0, 136, 204, 0.5);
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .telegram-chip .remove-chip {
            cursor: pointer;
            opacity: 0.7;
        }
        
        .telegram-chip .remove-chip:hover {
            opacity: 1;
        }
        
        .notification-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
        }
        
        .log-entry.success {
            color: #2ecc71;
        }
        
        .log-entry.error {
            color: #e74c3c;
        }
        
        .log-entry.info {
            color: #3498db;
        }
        
        .log-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .mass-notification-btn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .mass-notification-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        /* Стиль для точных цен */
        .price-fraction {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        .price-input-container {
            position: relative;
        }
        
        .price-input-container::after {
            content: 'монет';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        /* Стили для поля количества в карточке товара */
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .quantity-input {
            width: 70px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--secondary-color);
            color: white;
            border-radius: 5px;
            padding: 5px;
        }
        
        .quantity-input:focus {
            background: rgba(255,255,255,0.15);
            border-color: var(--secondary-color);
            color: white;
            box-shadow: 0 0 0 0.25rem rgba(0, 168, 255, 0.25);
        }
        
        .quantity-btn-group {
            display: flex;
            gap: 5px;
        }
        
        .quantity-btn {
            background: rgba(0, 168, 255, 0.2);
            border: 1px solid var(--secondary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background: var(--secondary-color);
            color: #000;
        }
        
        .add-to-cart-btn {
            flex-grow: 1;
        }
        
        /* Стили для быстрого добавления */
        .quick-add-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .quick-add-btn {
            background: rgba(0, 168, 255, 0.1);
            border: 1px solid var(--secondary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .quick-add-btn:hover {
            background: var(--secondary-color);
            color: #000;
        }
        
        .quick-add-btn.active {
            background: var(--secondary-color);
            color: #000;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Оверлей для админ-панели -->
    <div class="admin-overlay" id="admin-overlay"></div>
    
    <!-- Админ-панель -->
    <div class="admin-panel" id="admin-panel">
        <div class="p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 style="color: var(--secondary-color);">
                    <i class="fas fa-cogs me-2"></i>Панель управления
                </h4>
                <button class="btn btn-sm btn-outline-danger" id="close-admin-panel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Статус авторизации -->
            <div id="admin-auth-section">
                <div class="text-center mb-4">
                    <h5>Авторизация администратора</h5>
                    <p class="text-muted small">Введите данные для доступа к управлению товарами</p>
                </div>
                
                <form id="admin-login-form">
                    <div class="mb-3">
                        <label for="admin-username" class="form-label">Логин</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                            <input type="text" class="form-control" id="admin-username" placeholder="Введите логин" required>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="admin-password" class="form-label">Пароль</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                            <input type="password" class="form-control" id="admin-password" placeholder="Введите пароль" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-game w-100 mb-3">
                        <i class="fas fa-sign-in-alt me-2"></i>Войти
                    </button>
                </form>
            </div>
            
            <!-- Управление товарами и заказами (после авторизации) -->
            <div id="admin-controls" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Управление магазином</h5>
                    <button class="btn btn-sm btn-outline-warning" id="admin-logout">
                        <i class="fas fa-sign-out-alt me-1"></i>Выйти
                    </button>
                </div>
                
                <!-- Навигация по разделам -->
                <ul class="nav nav-tabs mb-3" id="adminTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-tab-pane">
                            <i class="fas fa-box me-1"></i>Товары
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-tab-pane">
                            <i class="fas fa-shopping-cart me-1"></i>Заказы
                            <span class="badge bg-danger ms-1" id="orders-count-badge">0</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="telegram-tab" data-bs-toggle="tab" data-bs-target="#telegram-tab-pane">
                            <i class="fab fa-telegram me-1"></i>Telegram
                            <span class="badge bg-info ms-1" id="sellers-count-badge">0</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Вкладка товаров -->
                    <div class="tab-pane fade show active" id="products-tab-pane">
                        <div class="admin-stats mb-4">
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <div class="product-card text-center p-2">
                                        <small>Товаров</small>
                                        <h6 id="admin-total-products">0</h6>
                                    </div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="product-card text-center p-2">
                                        <small>Категорий</small>
                                        <h6 id="admin-total-categories">0</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button class="btn btn-game w-100 mb-2" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                <i class="fas fa-plus me-2"></i>Добавить товар
                            </button>
                            
                            <button class="btn btn-outline-secondary w-100 mb-2" onclick="loadAllProducts()">
                                <i class="fas fa-sync me-2"></i>Обновить список
                            </button>
                            
                            <button class="btn btn-outline-info w-100" onclick="exportProducts()">
                                <i class="fas fa-download me-2"></i>Экспорт товаров
                            </button>
                        </div>
                        
                        <!-- Список товаров для быстрого управления -->
                        <div class="mt-4">
                            <h6>Быстрый доступ</h6>
                            <div class="list-group" id="quick-products-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- Товары будут загружены здесь -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Вкладка заказов -->
                    <div class="tab-pane fade" id="orders-tab-pane">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6>Все заказы</h6>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary active" onclick="filterOrders('all')">Все</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="filterOrders('pending')">Ожидают</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="filterOrders('completed')">Выданы</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="filterOrders('cancelled')">Отменены</button>
                                </div>
                            </div>
                            <input type="text" class="form-control form-control-sm" id="search-orders" placeholder="Поиск по заказам...">
                        </div>
                        
                        <div id="orders-list-container" style="max-height: 400px; overflow-y: auto;">
                            <!-- Список заказов будет здесь -->
                        </div>
                    </div>
                    
                    <!-- Вкладка Telegram -->
                    <div class="tab-pane fade" id="telegram-tab-pane">
                        <div class="product-card p-3 mb-3">
                            <h6 class="mb-3">
                                <i class="fab fa-telegram telegram-icon me-2"></i>Настройки Telegram
                            </h6>
                            
                            <div class="telegram-status" id="telegram-status">
                                <i class="fab fa-telegram"></i>
                                <div>
                                    <div>Telegram бот: <span id="telegram-status-text">Не настроен</span></div>
                                    <small class="text-muted" id="telegram-status-desc">Настройте бота для получения уведомлений</small>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-outline-secondary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#telegramSettingsModal">
                                    <i class="fas fa-cog me-2"></i>Настроить Telegram
                                </button>
                                
                                <button class="telegram-test-btn w-100" id="test-telegram-btn" disabled>
                                    <i class="fas fa-paper-plane me-1"></i>Тест уведомления
                                </button>
                                
                                <button class="btn btn-outline-warning w-100 mt-2" data-bs-toggle="modal" data-bs-target="#massNotificationModal">
                                    <i class="fas fa-bullhorn me-2"></i>Массовое уведомление
                                </button>
                            </div>
                        </div>
                        
                        <div class="product-card p-3">
                            <h6 class="mb-3">Статусы заказов в Telegram</h6>
                            <p class="small text-muted mb-2">При изменении статуса заказа в системе можно обновить сообщение в Telegram</p>
                            
                            <div class="alert alert-info small">
                                <i class="fas fa-info-circle me-2"></i>
                                При статусе "Выдан" сообщение будет удалено из Telegram чата
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Кнопка открытия админ-панели -->
    <button class="admin-btn" id="open-admin-panel" title="Панель администратора">
        <i class="fas fa-cogs"></i>
        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
    </button>
    
    <!-- Уведомление о заказе -->
    <div class="order-notification" id="order-notification" style="display: none;">
        <i class="fas fa-check-circle fa-2x"></i>
        <div>
            <strong>Заказ оформлен!</strong>
            <div id="notification-message">Уведомление отправлено продавцу</div>
        </div>
    </div>
    
    <div class="content-wrapper">
        <!-- Навигация -->
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-gamepad me-2"></i>DiverS
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#home">Главная</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#products">Товары</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#cart">Корзина <span id="cart-count" class="badge bg-danger cart-badge">0</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Заголовок игры -->
        <header class="game-header" id="home">
            <div class="container">
                <h1 class="display-4 fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                    <span style="color: var(--secondary-color);">DiverS</span> Store
                </h1>
                <p class="lead fs-4">Официальный магазин игровых предметов для TimeZero</p>
                <p class="mb-4">Снаряжение для настоящих сталкеров и наемников</p>
                <a href="#products" class="btn btn-game btn-lg mt-3">
                    <i class="fas fa-shopping-cart me-2"></i>В магазин
                </a>
            </div>
        </header>

        <!-- Каталог товаров -->
        <section class="container mt-5" id="products">
            <h2 class="text-center mb-4">Игровые товары</h2>
            
            <!-- Фильтры по категориям -->
            <div class="category-filter">
                <div class="text-center mb-3">
                    <h5>Категории снаряжения</h5>
                </div>
                <div class="d-flex flex-wrap justify-content-center">
                    <button class="category-btn active" data-filter="all">Все товары</button>
                    <button class="category-btn" data-filter="armor">Броня</button>
                    <button class="category-btn" data-filter="weapons">Оружие</button>
                    <button class="category-btn" data-filter="medicine">Медицина</button>
                    <button class="category-btn" data-filter="attachments">Встройки</button>
                    <button class="category-btn" data-filter="ammo">Патроны</button>
                    <button class="category-btn" data-filter="throwable">Метательное</button>
                </div>
            </div>
            
            <!-- Товары -->
            <div class="row" id="products-container">
                <!-- Товары будут загружены через JavaScript -->
            </div>
        </section>

        <!-- Корзина -->
        <section class="container mt-5" id="cart">
            <h2 class="text-center mb-4">Корзина покупок</h2>
            <div class="row">
                <div class="col-md-8">
                    <div id="cart-items">
                        <!-- Товары в корзине -->
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card" style="background: rgba(30,42,71,0.9); border: 2px solid var(--secondary-color);">
                        <div class="card-body">
                            <h5 class="card-title" style="color: var(--secondary-color);">Сумма заказа</h5>
                            <p>Товаров: <span id="total-items">0</span> шт.</p>
                            <p>Общая сумма: <span id="total-price">0.00</span> <i class="fas fa-coins currency-coin"></i></p>
                            <hr style="border-color: var(--secondary-color);">
                            <button class="btn btn-game w-100" id="checkout-btn">
                                <i class="fas fa-check me-2"></i>Оформить заказ
                            </button>
                            <button class="btn btn-outline-light w-100 mt-2" id="clear-cart">
                                <i class="fas fa-trash me-2"></i>Очистить корзину
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Футер -->
        <footer class="py-4 mt-5" style="background: rgba(26, 58, 95, 0.9); border-top: 2px solid var(--secondary-color);">
            <div class="container text-center">
                <p>&copy; 2023 DiverS Store. Все права защищены.</p>
                <p class="text-muted">Это демонстрационная версия магазина для игры TimeZero</p>
                <div class="mt-3">
                    <a href="#" class="text-secondary mx-2"><i class="fab fa-discord fa-lg"></i></a>
                    <a href="#" class="text-secondary mx-2"><i class="fab fa-telegram fa-lg"></i></a>
                    <a href="#" class="text-secondary mx-2"><i class="fab fa-vk fa-lg"></i></a>
                </div>
            </div>
        </footer>

        <!-- Модальное окно оформления заказа -->
        <div class="modal fade" id="checkoutModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="color: var(--secondary-color);">Оформление заказа</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="checkout-form">
                            <div class="mb-4">
                                <label for="game-nickname" class="form-label">Игровой никнейм в TimeZero</label>
                                <input type="text" class="form-control" id="game-nickname" required 
                                       placeholder="Введите ваш игровой ник">
                            </div>
                            
                            <div class="mb-4">
                                <p class="mb-2">Состав заказа:</p>
                                <div class="cart-summary" id="cart-summary" 
                                     style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                                    <!-- Товары будут добавлены через JavaScript -->
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <p>Сумма к оплате: <strong><span id="modal-total-price">0.00</span> <i class="fas fa-coins currency-coin"></i></strong></p>
                                <p class="text-muted small">После оформления заказа продавцы свяжутся с вами в игре для передачи товара</p>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-game" id="confirm-order">
                            <i class="fas fa-check me-1"></i>Подтвердить заказ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно добавления товара -->
        <div class="modal fade" id="addProductModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Добавить новый товар</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="add-product-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="new-product-name" class="form-label">Название товара</label>
                                    <input type="text" class="form-control" id="new-product-name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="new-product-category" class="form-label">Категория</label>
                                    <select class="form-control" id="new-product-category" required>
                                        <option value="armor">Броня</option>
                                        <option value="weapons">Оружие</option>
                                        <option value="medicine">Медицина</option>
                                        <option value="attachments">Встройки</option>
                                        <option value="ammo">Патроны</option>
                                        <option value="throwable">Метательное</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="new-product-description" class="form-label">Описание</label>
                                <textarea class="form-control" id="new-product-description" rows="2" required></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="new-product-price" class="form-label">Цена</label>
                                    <div class="price-input-container">
                                        <input type="number" class="form-control" id="new-product-price" 
                                               min="0.01" step="0.01" required 
                                               placeholder="0.00">
                                    </div>
                                    <small class="form-text text-muted">Цена в монетах. Можно указывать копейки (сотые доли)</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="new-product-image" class="form-label">Ссылка на изображение</label>
                                    <input type="url" class="form-control" id="new-product-image" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Особенности</label>
                                <div id="features-container">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control feature-input" placeholder="Особенность товара">
                                        <button class="btn btn-outline-danger" type="button" onclick="removeFeature(this)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addFeatureField()">
                                    <i class="fas fa-plus me-1"></i>Добавить особенность
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-game" id="save-product-btn">
                            <i class="fas fa-save me-1"></i>Сохранить товар
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно редактирования товара -->
        <div class="modal fade" id="editProductModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Редактировать товар</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-product-form">
                            <input type="hidden" id="edit-product-id">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="edit-product-name" class="form-label">Название товара</label>
                                    <input type="text" class="form-control" id="edit-product-name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="edit-product-category" class="form-label">Категория</label>
                                    <select class="form-control" id="edit-product-category" required>
                                        <option value="armor">Броня</option>
                                        <option value="weapons">Оружие</option>
                                        <option value="medicine">Медицина</option>
                                        <option value="attachments">Встройки</option>
                                        <option value="ammo">Патроны</option>
                                        <option value="throwable">Метательное</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit-product-description" class="form-label">Описание</label>
                                <textarea class="form-control" id="edit-product-description" rows="2" required></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="edit-product-price" class="form-label">Цена</label>
                                    <div class="price-input-container">
                                        <input type="number" class="form-control" id="edit-product-price" 
                                               min="0.01" step="0.01" required 
                                               placeholder="0.00">
                                    </div>
                                    <small class="form-text text-muted">Цена в монетах. Можно указывать копейки (сотые доли)</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="edit-product-image" class="form-label">Ссылка на изображение</label>
                                    <input type="url" class="form-control" id="edit-product-image" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Особенности</label>
                                <div id="edit-features-container">
                                    <!-- Особенности будут добавлены динамически -->
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEditFeatureField()">
                                    <i class="fas fa-plus me-1"></i>Добавить особенность
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-game" id="update-product-btn">
                            <i class="fas fa-sync me-1"></i>Обновить товар
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно настроек Telegram -->
        <div class="modal fade" id="telegramSettingsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fab fa-telegram me-2"></i>Настройки Telegram бота
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="telegram-settings-form">
                            <div class="mb-3">
                                <label for="telegram-bot-token" class="form-label">Токен бота</label>
                                <input type="text" class="form-control" id="telegram-bot-token" 
                                       placeholder="Введите токен бота (например: 1234567890:ABCdefGhIjKlMnOprSTUvWxYz)">
                                <small class="form-text text-muted">
                                    Получите токен у <a href="https://t.me/BotFather" target="_blank" class="text-info">@BotFather</a>
                                </small>
                            </div>
                            
                            <!-- Новая секция для управления продавцами -->
                            <div class="mb-3">
                                <label class="form-label">Управление продавцами</label>
                                <div class="sellers-container">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6>Список продавцов</h6>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="addSellerField()">
                                            <i class="fas fa-plus me-1"></i>Добавить продавца
                                        </button>
                                    </div>
                                    
                                    <div id="sellers-list">
                                        <!-- Список продавцов будет загружен здесь -->
                                    </div>
                                    
                                    <div class="telegram-chips" id="telegram-chips-container">
                                        <!-- Чипсы с продавцами будут здесь -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="notification-template" class="form-label">Шаблон уведомления</label>
                                <textarea class="form-control" id="notification-template" rows="6">
🛒 <b>НОВЫЙ ЗАКАЗ #{order_id}</b>

👤 <b>Покупатель:</b> {nickname}

📦 <b>Состав заказа:</b>
{order_items}

💰 <b>Итого:</b> {total_price} монет

🕐 <b>Время заказа:</b> {order_time}
📋 <b>Статус:</b> ⏳ Ожидает обработки

━━━━━━━━━━━━━━━━━━━━
<i>Используйте кнопки ниже для изменения статуса</i>
                                </textarea>
                                <small class="form-text text-muted">
                                    Доступные переменные: {nickname}, {order_items}, {total_price}, {order_time}, {order_id}
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Лог уведомлений</label>
                                <div class="notification-log" id="notification-log">
                                    <!-- Лог будет здесь -->
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>
                                    <b>Как настроить:</b><br>
                                    1. Создайте бота через @BotFather<br>
                                    2. Добавьте бота в чат/канал каждого продавца<br>
                                    3. Получите Chat ID каждого чата через @getmyid_bot<br>
                                    4. Добавьте продавцов через кнопку "Добавить продавца"
                                </small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-game" id="save-telegram-settings">
                            <i class="fas fa-save me-1"></i>Сохранить настройки
                        </button>
                        <button type="button" class="btn mass-notification-btn" id="test-all-sellers">
                            <i class="fas fa-broadcast-tower me-1"></i>Тест всем продавцам
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Добавляем новое модальное окно для массовых уведомлений -->
        <div class="modal fade" id="massNotificationModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-bullhorn me-2"></i>Массовое уведомление
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="mass-notification-text" class="form-label">Текст уведомления</label>
                            <textarea class="form-control" id="mass-notification-text" rows="4" 
                                      placeholder="Введите текст для всех продавцов"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Выберите продавцов</label>
                            <div id="mass-sellers-list">
                                <!-- Список продавцов для выбора -->
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <small>Уведомление будет отправлено всем выбранным продавцам</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-game" id="send-mass-notification">
                            <i class="fas fa-paper-plane me-1"></i>Отправить всем
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Данные товаров с поддержкой цен в сотых долях
        const products = [
            {
                id: 1,
                name: "Бронежилет 'Штурмовик'",
                description: "Тяжелый бронежилет с защитой 5 класса",
                price: 1250.50,
                category: "armor",
                image: "https://images.unsplash.com/photo-1588347818030-f6cf3ddf9c6f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["Защита 5 класса", "10 слотов для встроек", "Устойчивость к пулям"]
            },
            {
                id: 2,
                name: "Шлем 'Снайпер'",
                description: "Легкий шлем с маскировкой и защитой головы",
                price: 850.75,
                category: "armor",
                image: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["Защита 3 класса", "Камуфляж", "Крепление для ПНВ"]
            },
            {
                id: 3,
                name: "АК-74М 'Вепрь'",
                description: "Модернизированный автомат Калашникова",
                price: 2200.25,
                category: "weapons",
                image: "https://images.unsplash.com/photo-1595263181851-3c9c8d8c1c0e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["5.45×39 мм", "750 выстр/мин", "30 патронов в магазине"]
            },
            {
                id: 4,
                name: "Снайперская винтовка SV-98",
                description: "Русская снайперская винтовка с высокой точностью",
                price: 3200.00,
                category: "weapons",
                image: "https://images.unsplash.com/photo-1544531586-fde5298cdd40?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["7.62×54 мм", "Дальность 1000м", "Тактический прицел"]
            },
            {
                id: 5,
                name: "Аптечка первой помощи",
                description: "Полный комплект для восстановления здоровья",
                price: 350.99,
                category: "medicine",
                image: "https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["Восстанавливает 100% HP", "Лечит кровотечение", "5 использований"]
            },
            {
                id: 6,
                name: "Тактический прицел ACOG",
                description: "4x оптический прицел с подсветкой сетки",
                price: 950.50,
                category: "attachments",
                image: "https://images.unsplash.com/photo-1518611012118-696072aa579a?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["Увеличение 4x", "Подсветка сетки", "Водонепроницаемый"]
            },
            {
                id: 7,
                name: "Патроны 5.45 мм (120 шт)",
                description: "Боеприпасы для автоматов серии АК-74",
                price: 180.30,
                category: "ammo",
                image: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["Бронебойные", "120 патронов", "Высокая точность"]
            },
            {
                id: 8,
                name: "Осколочная граната Ф-1",
                description: "Ручная осколочная граната оборонительного типа",
                price: 450.75,
                category: "throwable",
                image: "https://images.unsplash.com/photo-1597262975004-30d6183a2d56?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["Радиус поражения 30м", "4 сек до взрыва", "200 осколков"]
            },
            {
                id: 9,
                name: "Бронежилет 'Разведчик'",
                description: "Легкий и маневренный для рейдов",
                price: 950.00,
                category: "armor",
                image: "https://images.unsplash.com/photo-1588347818030-f6cf3ddf9c6f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["Защита 3 класса", "Высокая мобильность", "6 слотов для встроек"]
            },
            {
                id: 10,
                name: "Медицинский стимулятор",
                description: "Временное увеличение характеристик",
                price: 280.45,
                category: "medicine",
                image: "https://images.unsplash.com/photo-1559757148-5c350d0d3c56?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["+30% к выносливости", "Длительность 5 мин", "Без побочных эффектов"]
            },
            {
                id: 11,
                name: "Глушитель 'Ночной охотник'",
                description: "Тактический глушитель для бесшумных операций",
                price: 750.20,
                category: "attachments",
                image: "https://images.unsplash.com/photo-1518611012118-696072aa579a?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["-90% к звуку выстрела", "Совместим с АК/М4", "Долговечный"]
            },
            {
                id: 12,
                name: "Дымовая граната",
                description: "Для создания дымовой завесы",
                price: 320.10,
                category: "throwable",
                image: "https://images.unsplash.com/photo-1597262975004-30d6183a2d56?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",
                features: ["Длительность 30 сек", "Радиус 15м", "Белый дым"]
            }
        ];

        // Данные администратора
        const ADMIN_CREDENTIALS = {
            username: "admin",
            password: "admin123"
        };

        // Настройки Telegram по умолчанию с поддержкой нескольких продавцов
        const DEFAULT_TELEGRAM_SETTINGS = {
            botToken: "",
            sellers: [], // Меняем chatId на массив продавцов
            notificationTemplate: `🛒 <b>НОВЫЙ ЗАКАЗ #{order_id}</b>

👤 <b>Покупатель:</b> {nickname}

📦 <b>Состав заказа:</b>
{order_items}

💰 <b>Итого:</b> {total_price} монет

🕐 <b>Время заказа:</b> {order_time}
📋 <b>Статус:</b> ⏳ Ожидает обработки

━━━━━━━━━━━━━━━━━━━━
<i>Используйте кнопки ниже для изменения статуса</i>`
        };

        // Корзина
        let cart = JSON.parse(localStorage.getItem('divers_cart')) || [];
        
        // Состояние админ-панели
        let adminLoggedIn = localStorage.getItem('admin_logged_in') === 'true';
        
        // История заказов
        let orderHistory = JSON.parse(localStorage.getItem('divers_orders')) || [];
        
        // Счетчик уведомлений
        let notificationCount = orderHistory.filter(order => order.status === 'pending').length;
        
        // Текущий фильтр заказов
        let currentOrderFilter = 'all';
        
        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', function() {
            renderProducts();
            renderCart();
            initAdminPanel();
            updateNotificationBadge();
            updateOrdersCount();
            
            // Загружаем настройки Telegram
            loadTelegramSettings();
            
            // Инициализация вкладок Bootstrap
            const tabEls = document.querySelectorAll('#adminTabs button[data-bs-toggle="tab"]');
            tabEls.forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', event => {
                    if (event.target.id === 'orders-tab') {
                        loadOrders();
                    }
                });
            });
            
            // Фильтрация товаров
            document.querySelectorAll('[data-filter]').forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    
                    // Обновление активной кнопки
                    document.querySelectorAll('[data-filter]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Фильтрация товаров
                    renderProducts(filter);
                });
            });
            
            // Оформление заказа
            document.getElementById('checkout-btn').addEventListener('click', function() {
                if (cart.length === 0) {
                    showAlert('Корзина пуста! Добавьте товары перед оформлением заказа.', 'warning');
                    return;
                }
                
                // Обновляем информацию в модальном окне
                document.getElementById('modal-total-price').textContent = 
                    formatPrice(cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0));
                
                // Заполняем список товаров в модальном окне
                const cartSummary = document.getElementById('cart-summary');
                cartSummary.innerHTML = '';
                
                cart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'd-flex justify-content-between align-items-center mb-2';
                    itemElement.innerHTML = `
                        <div>
                            <small>${item.name}</small><br>
                            <small class="text-muted">${item.quantity} × ${formatPrice(parseFloat(item.price))} монет</small>
                        </div>
                        <div>
                            <small>${formatPrice(parseFloat(item.price) * item.quantity)} монет</small>
                        </div>
                    `;
                    cartSummary.appendChild(itemElement);
                });
                
                const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
                modal.show();
            });
            
            // Подтверждение заказа
            document.getElementById('confirm-order').addEventListener('click', function() {
                const nickname = document.getElementById('game-nickname').value;
                
                if (!nickname) {
                    showAlert('Введите ваш игровой никнейм!', 'danger');
                    return;
                }
                
                if (nickname.length < 3) {
                    showAlert('Никнейм должен содержать минимум 3 символа!', 'danger');
                    return;
                }
                
                processOrder(nickname);
            });
            
            // Очистка корзины
            document.getElementById('clear-cart').addEventListener('click', function() {
                if (cart.length === 0) {
                    showAlert('Корзина уже пуста!', 'info');
                    return;
                }
                
                if (confirm('Вы уверены, что хотите очистить корзину?')) {
                    cart = [];
                    saveCart();
                    renderCart();
                    showAlert('Корзина очищена!', 'success');
                }
            });
            
            // Поиск заказов
            document.getElementById('search-orders')?.addEventListener('input', function(e) {
                filterOrders(currentOrderFilter, e.target.value);
            });
            
            // Плавная прокрутка
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    if (targetId === '#') return;
                    
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 80,
                            behavior: 'smooth'
                        });
                    }
                });
            });
            
            // Загружаем список продавцов для массовых уведомлений
            loadMassSellersList();
            
            // Тест всем продавцам
            document.getElementById('test-all-sellers')?.addEventListener('click', function() {
                testAllSellers();
            });
            
            // Массовая отправка уведомлений
            document.getElementById('send-mass-notification')?.addEventListener('click', function() {
                sendMassNotification();
            });
        });
        
        // Инициализация админ-панели
        function initAdminPanel() {
            // Открытие админ-панели
            document.getElementById('open-admin-panel').addEventListener('click', function() {
                openAdminPanel();
            });
            
            // Закрытие админ-панели
            document.getElementById('close-admin-panel').addEventListener('click', function() {
                closeAdminPanel();
            });
            
            // Закрытие по клику на оверлей
            document.getElementById('admin-overlay').addEventListener('click', function() {
                closeAdminPanel();
            });
            
            // Вход в админку
            document.getElementById('admin-login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;
                
                if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                    adminLoginSuccess(username);
                } else {
                    showAlert('Неверный логин или пароль!', 'danger');
                }
            });
            
            // Выход из админки
            document.getElementById('admin-logout').addEventListener('click', function() {
                adminLogout();
            });
            
            // Сохранение товара
            document.getElementById('save-product-btn').addEventListener('click', function() {
                saveProduct();
            });
            
            // Обновление товара
            document.getElementById('update-product-btn').addEventListener('click', function() {
                updateProduct();
            });
            
            // Сохранение настроек Telegram
            document.getElementById('save-telegram-settings').addEventListener('click', function() {
                saveTelegramSettings();
            });
            
            // Тест уведомления в Telegram
            document.getElementById('test-telegram-btn').addEventListener('click', function() {
                testTelegramNotification();
            });
            
            // Обновление состояния админ-панели
            updateAdminPanelState();
        }
        
        // Обработка заказа с поддержкой нескольких продавцов
        async function processOrder(nickname) {
            const orderId = generateOrderId();
            const orderTime = new Date().toLocaleString('ru-RU');
            
            // Рассчитываем общую сумму с учетом сотых долей
            const totalPrice = cart.reduce((sum, item) => {
                return parseFloat((sum + (parseFloat(item.price) * item.quantity)).toFixed(2));
            }, 0);
            
            // Создание заказа
            const order = {
                id: orderId,
                nickname: nickname,
                items: cart.map(item => ({
                    name: item.name,
                    quantity: item.quantity,
                    price: parseFloat(item.price),
                    total: parseFloat((parseFloat(item.price) * item.quantity).toFixed(2))
                })),
                totalPrice: totalPrice,
                time: orderTime,
                status: 'pending',
                telegramSent: false,
                telegramSentTo: []
            };
            
            // Добавление в историю
            orderHistory.push(order);
            localStorage.setItem('divers_orders', JSON.stringify(orderHistory));
            
            // Отправка уведомления всем продавцам
            const telegramResult = await sendTelegramNotification(order);
            
            // Обновление статуса заказа
            if (telegramResult.success) {
                order.telegramSent = true;
                order.telegramSentTo = telegramResult.sentTo;
                
                // Обновляем историю
                const orderIndex = orderHistory.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orderHistory[orderIndex] = order;
                    localStorage.setItem('divers_orders', JSON.stringify(orderHistory));
                }
                
                // Показываем уведомление пользователю
                showOrderNotification(true, `Уведомление отправлено ${telegramResult.sentTo.length} продавцам!`);
            } else {
                showOrderNotification(false, 'Заказ оформлен, но уведомление не отправлено. Продавец проверит заказ позже.');
            }
            
            // Обновление счетчика уведомлений
            updateNotificationBadge();
            updateOrdersCount();
            
            // Очистка корзины
            cart = [];
            saveCart();
            renderCart();
            
            // Закрытие модального окна
            bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
            
            // Очистка формы
            document.getElementById('checkout-form').reset();
            
            // Показать сообщение об успехе
            showAlert(`Заказ #${orderId} оформлен! Продавцы свяжутся с вами в игре для передачи товаров.`, 'success');
        }
        
        // Генерация ID заказа
        function generateOrderId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `${timestamp}${random}`.substr(4, 8);
        }
        
        // Загрузка настроек Telegram с поддержкой нескольких продавцов
        function loadTelegramSettings() {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            
            // Заполняем форму
            if (document.getElementById('telegram-bot-token')) {
                document.getElementById('telegram-bot-token').value = settings.botToken || '';
                document.getElementById('notification-template').value = settings.notificationTemplate || DEFAULT_TELEGRAM_SETTINGS.notificationTemplate;
                
                // Загружаем список продавцов
                renderSellersList(settings.sellers || []);
                
                // Обновляем чипсы
                updateSellerChips(settings.sellers || []);
                
                // Обновляем счетчик продавцов
                updateSellersCount(settings.sellers || []);
            }
            
            // Обновляем статус
            updateTelegramStatus(settings);
            
            // Загружаем лог уведомлений
            loadNotificationLog();
        }
        
        // Сохранение настроек Telegram с поддержкой нескольких продавцов
        function saveTelegramSettings() {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            
            // Сохраняем токен и шаблон
            settings.botToken = document.getElementById('telegram-bot-token').value.trim();
            settings.notificationTemplate = document.getElementById('notification-template').value.trim() || DEFAULT_TELEGRAM_SETTINGS.notificationTemplate;
            
            // Продавцы уже сохранены в отдельных функциях
            
            localStorage.setItem('divers_telegram_settings', JSON.stringify(settings));
            
            // Обновляем статус
            updateTelegramStatus(settings);
            
            // Закрываем модальное окно
            bootstrap.Modal.getInstance(document.getElementById('telegramSettingsModal')).hide();
            
            showAlert('Настройки Telegram сохранены!', 'success');
        }
        
        // Обновление статуса Telegram
        function updateTelegramStatus(settings) {
            const statusElement = document.getElementById('telegram-status');
            const statusText = document.getElementById('telegram-status-text');
            const statusDesc = document.getElementById('telegram-status-desc');
            const testButton = document.getElementById('test-telegram-btn');
            
            if (settings.botToken && settings.sellers && settings.sellers.length > 0) {
                statusElement.className = 'telegram-status connected';
                statusText.textContent = `Подключен (${settings.sellers.length} продавцов)`;
                statusDesc.textContent = 'Уведомления отправляются всем продавцам';
                testButton.disabled = false;
                testButton.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Тест уведомления';
            } else {
                statusElement.className = 'telegram-status disconnected';
                statusText.textContent = 'Не настроен';
                statusDesc.textContent = 'Настройте бота и добавьте продавцов';
                testButton.disabled = true;
                testButton.innerHTML = '<i class="fas fa-ban me-1"></i>Настройте Telegram';
            }
            
            // Обновляем счетчик продавцов в табе
            updateSellersCount(settings.sellers || []);
        }
        
        // Обновление счетчика продавцов
        function updateSellersCount(sellers) {
            const badge = document.getElementById('sellers-count-badge');
            if (sellers.length > 0) {
                badge.textContent = sellers.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Функция отображения списка продавцов
        function renderSellersList(sellers) {
            const container = document.getElementById('sellers-list');
            container.innerHTML = '';
            
            if (sellers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-users fa-2x mb-2 opacity-50"></i>
                        <p>Нет добавленных продавцов</p>
                        <small>Добавьте продавцов для получения уведомлений</small>
                    </div>
                `;
                return;
            }
            
            sellers.forEach((seller, index) => {
                const sellerElement = document.createElement('div');
                sellerElement.className = 'seller-card';
                sellerElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex-grow: 1;">
                            <div class="d-flex align-items-center mb-1">
                                <strong>${seller.name || 'Продавец ' + (index + 1)}</strong>
                                <span class="seller-role-badge ${seller.role === 'admin' ? 'seller-role-admin' : 'seller-role-seller'} ms-2">
                                    ${seller.role === 'admin' ? 'Админ' : 'Продавец'}
                                </span>
                            </div>
                            <div class="small text-muted">
                                <div>Chat ID: ${seller.chatId}</div>
                                ${seller.description ? `<div>${seller.description}</div>` : ''}
                            </div>
                        </div>
                        <div class="seller-actions">
                            <button class="btn btn-sm btn-outline-warning" onclick="editSeller(${index})" title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="testSellerNotification(${index})" title="Тест уведомление">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeSeller(${index})" title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <input type="hidden" class="seller-data" data-index="${index}" 
                           data-name="${seller.name || ''}" 
                           data-chatid="${seller.chatId}" 
                           data-description="${seller.description || ''}"
                           data-role="${seller.role || 'seller'}">
                `;
                container.appendChild(sellerElement);
            });
        }
        
        // Функция обновления чипсов продавцов
        function updateSellerChips(sellers) {
            const container = document.getElementById('telegram-chips-container');
            container.innerHTML = '';
            
            sellers.forEach((seller, index) => {
                const chip = document.createElement('div');
                chip.className = 'telegram-chip';
                chip.innerHTML = `
                    <i class="fab fa-telegram"></i>
                    <span>${seller.name || `Продавец ${index + 1}`}</span>
                    <span class="remove-chip" onclick="removeSeller(${index})">×</span>
                `;
                container.appendChild(chip);
            });
            
            // Показываем статистику
            if (sellers.length > 0) {
                const adminCount = sellers.filter(s => s.role === 'admin').length;
                const sellerCount = sellers.length - adminCount;
                
                const statsChip = document.createElement('div');
                statsChip.className = 'telegram-chip';
                statsChip.style.background = 'rgba(46, 204, 113, 0.2)';
                statsChip.style.borderColor = 'rgba(46, 204, 113, 0.5)';
                statsChip.innerHTML = `
                    <i class="fas fa-chart-bar"></i>
                    <span>${sellers.length} продавцов (${adminCount} админ, ${sellerCount} продавец)</span>
                `;
                container.appendChild(statsChip);
            }
        }
        
        // Функция добавления поля продавца
        function addSellerField(seller = null) {
            const container = document.getElementById('sellers-list');
            const index = seller ? seller.index : container.children.length;
            const isEdit = seller !== null;
            
            const sellerForm = document.createElement('div');
            sellerForm.className = 'seller-card';
            sellerForm.innerHTML = `
                <div class="mb-2">
                    <label class="form-label small">Имя продавца</label>
                    <input type="text" class="form-control form-control-sm seller-name-input" 
                           value="${isEdit ? seller.name : ''}" 
                           placeholder="Например: Иван (главный)">
                </div>
                
                <div class="mb-2">
                    <label class="form-label small">Chat ID</label>
                    <input type="text" class="form-control form-control-sm seller-chatid-input" 
                           value="${isEdit ? seller.chatId : ''}" 
                           placeholder="Введите Chat ID продавца" required>
                </div>
                
                <div class="mb-2">
                    <label class="form-label small">Роль</label>
                    <select class="form-control form-control-sm seller-role-input">
                        <option value="seller" ${isEdit && seller.role === 'seller' ? 'selected' : ''}>Продавец</option>
                        <option value="admin" ${isEdit && seller.role === 'admin' ? 'selected' : ''}>Администратор</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small">Описание (необязательно)</label>
                    <input type="text" class="form-control form-control-sm seller-desc-input" 
                           value="${isEdit ? seller.description : ''}" 
                           placeholder="Например: отвечает за оружие">
                </div>
                
                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="cancelSellerEdit(${index})">
                        Отмена
                    </button>
                    <button class="btn btn-sm btn-game" onclick="saveSeller(${index}, ${isEdit})">
                        ${isEdit ? 'Обновить' : 'Сохранить'}
                    </button>
                </div>
            `;
            
            if (isEdit) {
                // Заменяем существующий элемент
                const existingElement = container.children[index];
                if (existingElement) {
                    container.replaceChild(sellerForm, existingElement);
                }
            } else {
                container.appendChild(sellerForm);
            }
        }
        
        // Функция сохранения продавца
        function saveSeller(index, isEdit = false) {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            const sellers = settings.sellers || [];
            
            const sellerNameInput = document.querySelector(`.seller-card:nth-child(${index + 1}) .seller-name-input`);
            const sellerChatIdInput = document.querySelector(`.seller-card:nth-child(${index + 1}) .seller-chatid-input`);
            const sellerRoleInput = document.querySelector(`.seller-card:nth-child(${index + 1}) .seller-role-input`);
            const sellerDescInput = document.querySelector(`.seller-card:nth-child(${index + 1}) .seller-desc-input`);
            
            if (!sellerChatIdInput || !sellerChatIdInput.value.trim()) {
                showAlert('Введите Chat ID продавца!', 'danger');
                return;
            }
            
            const sellerData = {
                name: sellerNameInput.value.trim() || `Продавец ${sellers.length + 1}`,
                chatId: sellerChatIdInput.value.trim(),
                role: sellerRoleInput.value,
                description: sellerDescInput.value.trim(),
                notificationsEnabled: true
            };
            
            if (isEdit && index < sellers.length) {
                sellers[index] = sellerData;
            } else {
                sellers.push(sellerData);
            }
            
            settings.sellers = sellers;
            localStorage.setItem('divers_telegram_settings', JSON.stringify(settings));
            
            // Обновляем интерфейс
            renderSellersList(sellers);
            updateSellerChips(sellers);
            updateTelegramStatus(settings);
            
            showAlert(`Продавец "${sellerData.name}" ${isEdit ? 'обновлен' : 'добавлен'}!`, 'success');
            
            // Загружаем список для массовых уведомлений
            loadMassSellersList();
        }
        
        // Функция редактирования продавца
        function editSeller(index) {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            const sellers = settings.sellers || [];
            
            if (index >= sellers.length) return;
            
            const seller = sellers[index];
            seller.index = index;
            addSellerField(seller);
        }
        
        // Функция удаления продавца
        function removeSeller(index) {
            if (!confirm('Удалить этого продавца?')) return;
            
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            const sellers = settings.sellers || [];
            
            if (index >= sellers.length) return;
            
            const sellerName = sellers[index].name;
            sellers.splice(index, 1);
            settings.sellers = sellers;
            localStorage.setItem('divers_telegram_settings', JSON.stringify(settings));
            
            // Обновляем интерфейс
            renderSellersList(sellers);
            updateSellerChips(sellers);
            updateTelegramStatus(settings);
            
            showAlert(`Продавец "${sellerName}" удален!`, 'success');
            
            // Загружаем список для массовых уведомлений
            loadMassSellersList();
        }
        
        // Функция отмены редактирования
        function cancelSellerEdit(index) {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            renderSellersList(settings.sellers || []);
        }
        
        // Функция тестирования уведомления конкретному продавцу
        async function testSellerNotification(index) {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            const sellers = settings.sellers || [];
            
            if (index >= sellers.length) {
                showAlert('Продавец не найден!', 'danger');
                return;
            }
            
            const seller = sellers[index];
            
            if (!settings.botToken) {
                showAlert('Сначала настройте токен бота!', 'warning');
                return;
            }
            
            try {
                const testOrder = {
                    id: 'TEST' + Date.now().toString().substr(-6),
                    nickname: 'Тестовый покупатель',
                    items: [{
                        name: 'Тестовый товар',
                        quantity: 1,
                        price: 100.50,
                        total: 100.50
                    }],
                    totalPrice: 100.50,
                    time: new Date().toLocaleString('ru-RU'),
                    status: 'test'
                };
                
                showAlert(`Отправка тестового уведомления ${seller.name}...`, 'info');
                
                const result = await sendTelegramNotificationToSeller(settings.botToken, seller.chatId, testOrder, seller.role === 'admin');
                
                if (result.success) {
                    addNotificationLog(`✅ Тест отправлен ${seller.name}`, 'success');
                    showAlert(`Тестовое уведомление отправлено ${seller.name}!`, 'success');
                } else {
                    addNotificationLog(`❌ Ошибка отправки ${seller.name}: ${result.error}`, 'error');
                    showAlert(`Ошибка отправки ${seller.name}: ${result.error}`, 'danger');
                }
            } catch (error) {
                console.error('Ошибка тестовой отправки:', error);
                addNotificationLog(`❌ Ошибка отправки ${seller.name}: ${error.message}`, 'error');
                showAlert('Ошибка при отправке тестового уведомления', 'danger');
            }
        }
        
        // Обновленная функция отправки уведомлений всем продавцам
        async function sendTelegramNotification(order) {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            const sellers = settings.sellers || [];
            
            if (!settings.botToken || sellers.length === 0) {
                console.warn('Telegram bot не настроен или нет продавцов');
                addNotificationLog('❌ Telegram не настроен или нет продавцов', 'error');
                return { success: false, messageId: null, sentTo: [] };
            }
            
            let mainMessageId = null;
            const sentTo = [];
            
            try {
                // Отправляем каждому продавцу
                for (const seller of sellers) {
                    if (!seller.notificationsEnabled) continue;
                    
                    try {
                        // Для администраторов отправляем с кнопками, для обычных продавцов - без кнопок
                        const result = await sendTelegramNotificationToSeller(
                            settings.botToken, 
                            seller.chatId, 
                            order, 
                            seller.role === 'admin'
                        );
                        
                        if (result.success) {
                            sentTo.push({
                                name: seller.name,
                                chatId: seller.chatId,
                                messageId: result.messageId,
                                role: seller.role
                            });
                            
                            // Первый успешный администратор считается основным
                            if (seller.role === 'admin' && !mainMessageId) {
                                mainMessageId = result.messageId;
                            }
                            
                            addNotificationLog(`✅ Отправлено ${seller.name} (${seller.role})`, 'success');
                        } else {
                            addNotificationLog(`❌ Ошибка у ${seller.name}: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        console.error(`Ошибка отправки продавцу ${seller.name}:`, error);
                        addNotificationLog(`❌ Ошибка отправки ${seller.name}`, 'error');
                    }
                    
                    // Небольшая пауза между отправками, чтобы не спамить API
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                return { 
                    success: sentTo.length > 0, 
                    messageId: mainMessageId, 
                    sentTo: sentTo,
                    totalSellers: sellers.length
                };
            } catch (error) {
                console.error('Ошибка при отправке уведомлений:', error);
                addNotificationLog('❌ Общая ошибка отправки', 'error');
                return { success: false, messageId: null, sentTo: [] };
            }
        }
        
        // Вспомогательная функция отправки уведомления конкретному продавцу
        async function sendTelegramNotificationToSeller(botToken, chatId, order, includeButtons = false) {
            try {
                // Формируем список товаров
                const orderItems = order.items.map(item => 
                    `• ${item.name} × ${item.quantity} = ${formatPrice(item.total)} монет`
                ).join('\n');
                
                // Заменяем переменные в шаблоне
                const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
                let message = settings.notificationTemplate || DEFAULT_TELEGRAM_SETTINGS.notificationTemplate;
                message = message.replace(/{nickname}/g, order.nickname)
                                .replace(/{order_items}/g, orderItems)
                                .replace(/{total_price}/g, formatPrice(order.totalPrice))
                                .replace(/{order_time}/g, order.time)
                                .replace(/{order_id}/g, order.id);
                
                // Создаем клавиатуру только если нужно
                const keyboard = includeButtons ? {
                    inline_keyboard: [
                        [
                            {
                                text: "✅ Выдан",
                                callback_data: `completed_${order.id}`
                            },
                            {
                                text: "❌ Отменен",
                                callback_data: `cancelled_${order.id}`
                            }
                        ]
                    ]
                } : null;
                
                // Отправляем запрос к API Telegram
                const payload = {
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'HTML',
                    disable_notification: false
                };
                
                if (keyboard) {
                    payload.reply_markup = keyboard;
                }
                
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    console.log(`Уведомление отправлено продавцу ${chatId}, message_id:`, data.result.message_id);
                    return { success: true, messageId: data.result.message_id };
                } else {
                    console.error('Ошибка отправки продавцу:', data.description);
                    return { success: false, error: data.description };
                }
            } catch (error) {
                console.error('Ошибка при отправке продавцу:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Обновляем функцию обновления статуса заказа в Telegram
        async function updateTelegramOrderStatus(orderId, newStatus) {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            const order = orderHistory.find(o => o.id === orderId);
            
            if (!settings.botToken || !order || !order.telegramSentTo || order.telegramSentTo.length === 0) {
                return false;
            }
            
            let updatedCount = 0;
            
            // Обновляем статус только у администраторов (у которых были кнопки)
            const adminSellers = order.telegramSentTo.filter(s => s.role === 'admin');
            
            for (const seller of adminSellers) {
                if (!seller.messageId) continue;
                
                try {
                    // Получаем статус заказа
                    const statusText = getStatusText(newStatus);
                    const statusEmoji = getStatusEmoji(newStatus);
                    
                    // Если статус "выдан" - удаляем сообщение
                    if (newStatus === 'completed') {
                        const deleteResponse = await fetch(`https://api.telegram.org/bot${settings.botToken}/deleteMessage`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chat_id: seller.chatId,
                                message_id: seller.messageId
                            })
                        });
                        
                        const deleteData = await deleteResponse.json();
                        if (deleteData.ok) {
                            updatedCount++;
                            addNotificationLog(`🗑️ Сообщение удалено у ${seller.name}`, 'success');
                        }
                    } else if (newStatus === 'cancelled') {
                        // Если статус "отменен" - редактируем сообщение
                        const orderItems = order.items.map(item => 
                            `• ${item.name} × ${item.quantity} = ${formatPrice(item.total)} монет`
                        ).join('\n');
                        
                        let message = `🛒 <b>ЗАКАЗ #${orderId} ОТМЕНЕН</b>\n\n`;
                        message += `👤 <b>Покупатель:</b> ${order.nickname}\n\n`;
                        message += `📦 <b>Состав заказа:</b>\n${orderItems}\n\n`;
                        message += `💰 <b>Итого:</b> ${formatPrice(order.totalPrice)} монет\n\n`;
                        message += `🕐 <b>Время заказа:</b> ${order.time}\n`;
                        message += `📋 <b>Статус:</b> ${statusEmoji} ${statusText}`;
                        
                        const editResponse = await fetch(`https://api.telegram.org/bot${settings.botToken}/editMessageText`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chat_id: seller.chatId,
                                message_id: seller.messageId,
                                text: message,
                                parse_mode: 'HTML'
                            })
                        });
                        
                        const editData = await editResponse.json();
                        if (editData.ok) {
                            updatedCount++;
                            addNotificationLog(`✏️ Статус обновлен у ${seller.name}`, 'success');
                        }
                    }
                } catch (error) {
                    console.error(`Ошибка при обновлении статуса у продавца ${seller.name}:`, error);
                    addNotificationLog(`❌ Ошибка обновления у ${seller.name}`, 'error');
                }
            }
            
            return updatedCount > 0;
        }
        
        // Функция загрузки лога уведомлений
        function loadNotificationLog() {
            const logContainer = document.getElementById('notification-log');
            const log = JSON.parse(localStorage.getItem('divers_notification_log')) || [];
            
            logContainer.innerHTML = '';
            
            if (log.length === 0) {
                logContainer.innerHTML = '<div class="text-center text-muted py-2">Нет записей в логе</div>';
                return;
            }
            
            // Показываем последние 10 записей
            const recentLogs = log.slice(-10).reverse();
            
            recentLogs.forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${entry.type || 'info'}`;
                logEntry.innerHTML = `
                    <span>${entry.message}</span>
                    <span class="log-time">${entry.time}</span>
                `;
                logContainer.appendChild(logEntry);
            });
        }
        
        // Функция добавления записи в лог
        function addNotificationLog(message, type = 'info') {
            const log = JSON.parse(localStorage.getItem('divers_notification_log')) || [];
            
            const logEntry = {
                message: message,
                type: type,
                time: new Date().toLocaleTimeString('ru-RU')
            };
            
            log.push(logEntry);
            
            // Храним только последние 50 записей
            if (log.length > 50) {
                log.shift();
            }
            
            localStorage.setItem('divers_notification_log', JSON.stringify(log));
            
            // Обновляем отображение лога
            loadNotificationLog();
        }
        
        // Функция тестирования уведомлений всем продавцам
        async function testAllSellers() {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            const sellers = settings.sellers || [];
            
            if (sellers.length === 0) {
                showAlert('Нет добавленных продавцов!', 'warning');
                return;
            }
            
            if (!settings.botToken) {
                showAlert('Сначала настройте токен бота!', 'warning');
                return;
            }
            
            try {
                showAlert(`Отправка тестовых уведомлений ${sellers.length} продавцам...`, 'info');
                
                const testOrder = {
                    id: 'TEST' + Date.now().toString().substr(-6),
                    nickname: 'Тестовый покупатель',
                    items: [{
                        name: 'Тестовый товар',
                        quantity: 1,
                        price: 100.50,
                        total: 100.50
                    }],
                    totalPrice: 100.50,
                    time: new Date().toLocaleString('ru-RU'),
                    status: 'test'
                };
                
                let successCount = 0;
                
                for (const seller of sellers) {
                    try {
                        const result = await sendTelegramNotificationToSeller(
                            settings.botToken, 
                            seller.chatId, 
                            testOrder, 
                            seller.role === 'admin'
                        );
                        
                        if (result.success) {
                            successCount++;
                            addNotificationLog(`✅ Тест отправлен ${seller.name}`, 'success');
                        } else {
                            addNotificationLog(`❌ Ошибка у ${seller.name}: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        addNotificationLog(`❌ Ошибка отправки ${seller.name}`, 'error');
                    }
                    
                    // Пауза между отправками
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                showAlert(`Тестовые уведомления отправлены! Успешно: ${successCount}/${sellers.length}`, 
                         successCount === sellers.length ? 'success' : 'warning');
            } catch (error) {
                console.error('Ошибка массовой тестовой отправки:', error);
                showAlert('Ошибка при отправке тестовых уведомлений', 'danger');
            }
        }
        
        // Функция загрузки списка продавцов для массовых уведомлений
        function loadMassSellersList() {
            const container = document.getElementById('mass-sellers-list');
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            const sellers = settings.sellers || [];
            
            container.innerHTML = '';
            
            sellers.forEach((seller, index) => {
                const sellerCheck = document.createElement('div');
                sellerCheck.className = 'form-check';
                sellerCheck.innerHTML = `
                    <input class="form-check-input" type="checkbox" 
                           id="mass-seller-${index}" checked 
                           value="${seller.chatId}" data-name="${seller.name}">
                    <label class="form-check-label" for="mass-seller-${index}">
                        ${seller.name} (${seller.role === 'admin' ? 'Админ' : 'Продавец'})
                        <small class="text-muted d-block">${seller.chatId}</small>
                    </label>
                `;
                container.appendChild(sellerCheck);
            });
        }
        
        // Функция отправки массового уведомления
        async function sendMassNotification() {
            const message = document.getElementById('mass-notification-text').value.trim();
            if (!message) {
                showAlert('Введите текст уведомления!', 'danger');
                return;
            }
            
            const checkboxes = document.querySelectorAll('#mass-sellers-list .form-check-input:checked');
            if (checkboxes.length === 0) {
                showAlert('Выберите хотя бы одного продавца!', 'danger');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            if (!settings.botToken) {
                showAlert('Сначала настройте токен бота!', 'warning');
                return;
            }
            
            try {
                showAlert(`Отправка массового уведомления ${checkboxes.length} продавцам...`, 'info');
                
                let successCount = 0;
                
                for (const checkbox of checkboxes) {
                    const chatId = checkbox.value;
                    const sellerName = checkbox.dataset.name;
                    
                    try {
                        const response = await fetch(`https://api.telegram.org/bot${settings.botToken}/sendMessage`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chat_id: chatId,
                                text: `📢 <b>МАССОВОЕ УВЕДОМЛЕНИЕ</b>\n\n${message}\n\n<small>Отправлено: ${new Date().toLocaleString('ru-RU')}</small>`,
                                parse_mode: 'HTML'
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.ok) {
                            successCount++;
                            addNotificationLog(`📢 Массовое уведомление отправлено ${sellerName}`, 'success');
                        } else {
                            addNotificationLog(`❌ Ошибка массового уведомления ${sellerName}: ${data.description}`, 'error');
                        }
                    } catch (error) {
                        addNotificationLog(`❌ Ошибка отправки массового уведомления ${sellerName}`, 'error');
                    }
                    
                    // Пауза между отправками
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                // Закрываем модальное окно
                bootstrap.Modal.getInstance(document.getElementById('massNotificationModal')).hide();
                
                showAlert(`Массовое уведомление отправлено! Успешно: ${successCount}/${checkboxes.length}`, 
                         successCount === checkboxes.length ? 'success' : 'warning');
            } catch (error) {
                console.error('Ошибка массовой отправки:', error);
                showAlert('Ошибка при отправке массового уведомления', 'danger');
            }
        }
        
        // Старая функция тестового уведомления (для обратной совместимости)
        async function testTelegramNotification() {
            const settings = JSON.parse(localStorage.getItem('divers_telegram_settings')) || DEFAULT_TELEGRAM_SETTINGS;
            
            if (!settings.botToken || !settings.sellers || settings.sellers.length === 0) {
                showAlert('Сначала настройте Telegram бота и добавьте продавцов!', 'warning');
                return;
            }
            
            // Используем новую функцию для теста первого продавца
            testSellerNotification(0);
        }
        
        // Функция форматирования цены с двумя знаками после запятой
        function formatPrice(price) {
            // Преобразуем в число, если это строка
            const numPrice = typeof price === 'string' ? parseFloat(price) : price;
            
            // Проверяем, является ли число
            if (isNaN(numPrice)) {
                return '0.00';
            }
            
            // Форматируем с двумя знаками после запятой
            const formatted = numPrice.toFixed(2);
            
            // Убираем лишние нули в конце, если они есть
            return formatted.replace(/\.00$/, '').replace(/(\.\d)0$/, '$1');
        }
        
        // Функция форматирования цены для отображения
        function formatPriceForDisplay(price) {
            const formatted = formatPrice(price);
            
            // Разделяем целую и дробную части
            const parts = formatted.split('.');
            
            if (parts.length === 2) {
                return `${parts[0]}<span class="price-fraction">.${parts[1]}</span>`;
            }
            
            return formatted;
        }
        
        // Функция добавления товара в корзину с указанием количества
        function addToCartWithQuantity(productId, quantity) {
            const currentProducts = JSON.parse(localStorage.getItem('divers_products')) || products;
            const product = currentProducts.find(p => p.id === productId);
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: parseFloat(product.price),
                    quantity: quantity,
                    category: product.category
                });
            }
            
            saveCart();
            renderCart();
            
            // Анимация добавления
            const btn = event.target.closest('.add-to-cart-btn');
            if (btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-1"></i>Добавлено';
                btn.classList.remove('btn-game');
                btn.style.background = '#2ecc71';
                
                showAlert(`"${product.name}" (${quantity} шт.) добавлен в корзину!`, 'success');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.add('btn-game');
                    btn.style.background = '';
                }, 1500);
            } else {
                showAlert(`"${product.name}" (${quantity} шт.) добавлен в корзину!`, 'success');
            }
        }
        
        // Функция быстрого добавления определенного количества
        function quickAddToCart(productId, quantity) {
            addToCartWithQuantity(productId, quantity);
        }
        
        // Функция изменения количества в карточке товара
        function changeProductQuantity(productId, change) {
            const input = document.querySelector(`input[data-product-id="${productId}"]`);
            if (input) {
                let newValue = parseInt(input.value) + change;
                if (newValue < 1) newValue = 1;
                if (newValue > 999999) newValue = 999999;
                input.value = newValue;
            }
        }
        
        // Функция добавления товара в корзину из карточки
        function addToCartFromCard(productId) {
            const input = document.querySelector(`input[data-product-id="${productId}"]`);
            if (input) {
                const quantity = parseInt(input.value) || 1;
                addToCartWithQuantity(productId, quantity);
                // Сбрасываем значение на 1 после добавления
                input.value = 1;
            }
        }
        
        // Загрузка заказов
        function loadOrders() {
            const container = document.getElementById('orders-list-container');
            
            if (orderHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-shopping-cart fa-3x mb-3 opacity-50"></i>
                        <p>Нет заказов</p>
                    </div>
                `;
                return;
            }
            
            // Фильтрация заказов
            let filteredOrders = orderHistory;
            
            if (currentOrderFilter !== 'all') {
                filteredOrders = orderHistory.filter(order => order.status === currentOrderFilter);
            }
            
            // Поиск
            const searchTerm = document.getElementById('search-orders')?.value.toLowerCase() || '';
            if (searchTerm) {
                filteredOrders = filteredOrders.filter(order => 
                    order.nickname.toLowerCase().includes(searchTerm) ||
                    order.id.toLowerCase().includes(searchTerm)
                );
            }
            
            // Сортировка по времени (новые сверху)
            filteredOrders.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            container.innerHTML = '';
            
            filteredOrders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = `order-card ${order.status}`;
                orderElement.id = `order-${order.id}`;
                
                const statusClass = getStatusClass(order.status);
                const statusText = getStatusText(order.status);
                const statusEmoji = getStatusEmoji(order.status);
                
                // Формируем список товаров
                const orderItems = order.items.map(item => 
                    `<div class="d-flex justify-content-between">
                        <span>${item.name} × ${item.quantity}</span>
                        <span>${formatPrice(item.total)} монет</span>
                    </div>`
                ).join('');
                
                orderElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-1">Заказ #${order.id}</h6>
                            <small class="text-muted">${order.time}</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="status-badge ${statusClass}">
                                ${statusEmoji} ${statusText}
                            </span>
                            ${order.status === 'pending' ? `
                            <div class="order-actions">
                                <button class="btn btn-sm btn-success" onclick="changeOrderStatus('${order.id}', 'completed')" title="Отметить как выданный">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="changeOrderStatus('${order.id}', 'cancelled')" title="Отменить заказ">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <strong><i class="fas fa-user me-1"></i>${order.nickname}</strong>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">Товары:</small>
                        <div class="mt-1">
                            ${orderItems}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <strong>Итого: ${formatPrice(order.totalPrice)} <i class="fas fa-coins currency-coin"></i></strong>
                        </div>
                        <div>
                            <small class="text-muted">
                                ${order.telegramSent ? 
                                    `<i class="fab fa-telegram text-info" title="Отправлено в Telegram"></i>` : 
                                    `<i class="fab fa-telegram text-muted" title="Не отправлено в Telegram"></i>`
                                }
                            </small>
                        </div>
                    </div>
                `;
                
                container.appendChild(orderElement);
            });
        }
        
        // Фильтрация заказов
        function filterOrders(filter, searchTerm = '') {
            currentOrderFilter = filter;
            
            // Обновляем активные кнопки фильтра
            document.querySelectorAll('#orders-tab-pane .btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target?.classList?.add('active');
            
            loadOrders();
        }
        
        // Обновление счетчика заказов
        function updateOrdersCount() {
            const pendingOrders = orderHistory.filter(order => order.status === 'pending').length;
            const badge = document.getElementById('orders-count-badge');
            
            if (pendingOrders > 0) {
                badge.textContent = pendingOrders;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Изменение статуса заказа
        async function changeOrderStatus(orderId, newStatus) {
            const orderIndex = orderHistory.findIndex(o => o.id === orderId);
            
            if (orderIndex === -1) {
                showAlert('Заказ не найден!', 'danger');
                return;
            }
            
            const oldStatus = orderHistory[orderIndex].status;
            
            if (oldStatus !== 'pending') {
                showAlert('Статус этого заказа уже изменен!', 'warning');
                return;
            }
            
            if (confirm(`Вы уверены, что хотите изменить статус заказа #${orderId} на "${getStatusText(newStatus)}"?`)) {
                // Обновляем статус в истории
                orderHistory[orderIndex].status = newStatus;
                localStorage.setItem('divers_orders', JSON.stringify(orderHistory));
                
                // Обновляем сообщение в Telegram
                const telegramUpdated = await updateTelegramOrderStatus(orderId, newStatus);
                
                if (telegramUpdated) {
                    showAlert(`Статус заказа #${orderId} изменен на "${getStatusText(newStatus)}". Сообщение в Telegram обновлено.`, 'success');
                } else {
                    showAlert(`Статус заказа #${orderId} изменен на "${getStatusText(newStatus)}".`, 'info');
                }
                
                // Обновляем интерфейс
                updateNotificationBadge();
                updateOrdersCount();
                loadOrders();
                
                // Если статус "выдан", обновляем счетчик уведомлений
                if (newStatus === 'completed') {
                    showAlert(`Заказ #${orderId} отмечен как выдан. Сообщение удалено из Telegram.`, 'success');
                }
            }
        }
        
        // Показ уведомления о заказе
        function showOrderNotification(success, message) {
            const notification = document.getElementById('order-notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            
            if (success) {
                notification.style.background = 'linear-gradient(45deg, #2ecc71, #27ae60)';
            } else {
                notification.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
            }
            
            notification.style.display = 'flex';
            
            // Автоматическое скрытие через 5 секунд
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Обновление бейджа уведомлений
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-count');
            notificationCount = orderHistory.filter(order => order.status === 'pending').length;
            
            if (notificationCount > 0) {
                badge.textContent = notificationCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Открытие админ-панели
        function openAdminPanel() {
            document.getElementById('admin-panel').classList.add('active');
            document.getElementById('admin-overlay').classList.add('active');
            
            // Загружаем заказы при открытии панели
            loadOrders();
            
            // Сбрасываем счетчик при открытии
            notificationCount = 0;
            updateNotificationBadge();
        }
        
        // Закрытие админ-панели
        function closeAdminPanel() {
            document.getElementById('admin-panel').classList.remove('active');
            document.getElementById('admin-overlay').classList.remove('active');
        }
        
        // Успешный вход в админку
        function adminLoginSuccess(username) {
            adminLoggedIn = true;
            localStorage.setItem('admin_logged_in', 'true');
            localStorage.setItem('admin_username', username);
            
            updateAdminPanelState();
            showAlert('Успешный вход в панель администратора!', 'success');
            loadQuickProducts();
            loadOrders();
        }
        
        // Выход из админки
        function adminLogout() {
            adminLoggedIn = false;
            localStorage.removeItem('admin_logged_in');
            localStorage.removeItem('admin_username');
            
            updateAdminPanelState();
            showAlert('Вы вышли из панели администратора', 'info');
        }
        
        // Обновление состояния админ-панели
        function updateAdminPanelState() {
            if (adminLoggedIn) {
                document.getElementById('admin-auth-section').style.display = 'none';
                document.getElementById('admin-controls').style.display = 'block';
                loadQuickProducts();
            } else {
                document.getElementById('admin-auth-section').style.display = 'block';
                document.getElementById('admin-controls').style.display = 'none';
            }
        }
        
        // Загрузка быстрых товаров
        function loadQuickProducts() {
            const products = JSON.parse(localStorage.getItem('divers_products')) || getDefaultProducts();
            const container = document.getElementById('quick-products-list');
            
            // Обновление статистики
            const categories = new Set(products.map(p => p.category));
            document.getElementById('admin-total-products').textContent = products.length;
            document.getElementById('admin-total-categories').textContent = categories.size;
            
            container.innerHTML = '';
            
            products.slice(0, 5).forEach(product => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.style.cssText = 'background: rgba(255,255,255,0.1); color: white; border-color: rgba(0,168,255,0.2);';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small>${product.name}</small><br>
                            <small class="text-muted">${formatPrice(product.price)} <i class="fas fa-coins"></i></small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); quickEditProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="event.stopPropagation(); quickDeleteProduct(${product.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            if (products.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-2">Нет товаров</div>';
            }
        }
        
        // Быстрое редактирование товара
        function quickEditProduct(productId) {
            editProduct(productId);
            closeAdminPanel();
        }
        
        // Быстрое удаление товара
        function quickDeleteProduct(productId) {
            if (confirm('Удалить товар?')) {
                deleteProduct(productId);
                loadQuickProducts();
            }
        }
        
        // Отображение товаров с поддержкой указания количества
        function renderProducts(filter = 'all') {
            const container = document.getElementById('products-container');
            const currentProducts = JSON.parse(localStorage.getItem('divers_products')) || products;
            
            container.innerHTML = '';
            
            const filteredProducts = filter === 'all' 
                ? currentProducts 
                : currentProducts.filter(product => product.category === filter);
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x mb-3" style="color: var(--secondary-color);"></i>
                        <h4>Товары в этой категории временно отсутствуют</h4>
                        <p>Попробуйте выбрать другую категорию</p>
                    </div>
                `;
                return;
            }
            
            filteredProducts.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'col-md-4 col-lg-3';
                
                // Определяем цвет категории
                const categoryColors = {
                    'armor': '#3498db',
                    'weapons': '#e74c3c',
                    'medicine': '#2ecc71',
                    'attachments': '#9b59b6',
                    'ammo': '#f39c12',
                    'throwable': '#1abc9c'
                };
                
                productElement.innerHTML = `
                    <div class="product-card h-100">
                        <div style="position: relative;">
                            <img src="${product.image}" class="product-img" alt="${product.name}">
                            <span class="category-badge" style="background: ${categoryColors[product.category] || '#666'}">
                                ${getCategoryName(product.category)}
                            </span>
                        </div>
                        <div class="p-3">
                            <h5>${product.name}</h5>
                            <p class="text-muted small">${product.description}</p>
                            ${product.features ? `
                                <div class="mt-2 mb-3">
                                    ${product.features.map(feature => 
                                        `<span class="badge bg-secondary me-1 mb-1">${feature}</span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="price-tag">${formatPriceForDisplay(product.price)} <i class="fas fa-coins currency-coin"></i></span>
                            </div>
                            
                            <!-- Кнопки быстрого добавления -->
                            <div class="quick-add-buttons">
                                <button class="quick-add-btn" onclick="quickAddToCart(${product.id}, 1)">1 шт</button>
                                <button class="quick-add-btn" onclick="quickAddToCart(${product.id}, 3)">3 шт</button>
                                <button class="quick-add-btn" onclick="quickAddToCart(${product.id}, 5)">5 шт</button>
                                <button class="quick-add-btn" onclick="quickAddToCart(${product.id}, 10)">10 шт</button>
                            </div>
                            
                            <!-- Управление количеством -->
                            <div class="quantity-controls">
                                <div class="quantity-btn-group">
                                    <button class="quantity-btn" onclick="changeProductQuantity(${product.id}, -1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" 
                                           class="form-control quantity-input" 
                                           data-product-id="${product.id}"
                                           value="1" 
                                           min="1" 
                                           max="999999"
                                           onchange="validateQuantity(this)">
                                    <button class="quantity-btn" onclick="changeProductQuantity(${product.id}, 1)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <button class="btn btn-game btn-sm add-to-cart-btn" onclick="addToCartFromCard(${product.id})">
                                    <i class="fas fa-cart-plus me-1"></i>В корзину
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(productElement);
            });
        }
        
        // Валидация ввода количества
        function validateQuantity(input) {
            let value = parseInt(input.value);
            if (isNaN(value) || value < 1) {
                input.value = 1;
            } else if (value > 999999) {
                input.value = 999999;
            }
        }
        
        // Старая функция для обратной совместимости
        function addToCart(productId) {
            addToCartWithQuantity(productId, 1);
        }
        
        // Отображение корзины
        function renderCart() {
            const container = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-count');
            const totalItems = document.getElementById('total-items');
            const totalPrice = document.getElementById('total-price');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart empty-cart-icon"></i>
                        <h4>Ваша корзина пуста</h4>
                        <p>Добавьте товары из каталога</p>
                        <a href="#products" class="btn btn-game">Перейти к товарам</a>
                    </div>
                `;
                cartCount.textContent = '0';
                totalItems.textContent = '0';
                totalPrice.textContent = '0.00';
                return;
            }
            
            container.innerHTML = '';
            let itemsCount = 0;
            let priceTotal = 0;
            
            cart.forEach((item, index) => {
                itemsCount += item.quantity;
                priceTotal = parseFloat((priceTotal + (parseFloat(item.price) * item.quantity)).toFixed(2));
                
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="flex-grow: 1;">
                            <h6>${item.name}</h6>
                            <div class="d-flex align-items-center">
                                <span class="badge" style="background: ${getCategoryColor(item.category)}; margin-right: 10px;">
                                    ${getCategoryName(item.category)}
                                </span>
                                <span>${formatPrice(item.price)} <i class="fas fa-coins currency-coin"></i> × ${item.quantity}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="mb-2">${formatPrice(parseFloat(item.price) * item.quantity)} <i class="fas fa-coins currency-coin"></i></div>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="updateQuantity(${item.id}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromCart(${item.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(itemElement);
            });
            
            cartCount.textContent = itemsCount;
            totalItems.textContent = itemsCount;
            totalPrice.textContent = formatPrice(priceTotal);
        }
        
        // Обновление количества товара в корзине
        function updateQuantity(productId, newQuantity) {
            if (newQuantity < 1) {
                removeFromCart(productId);
                return;
            }
            
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity = newQuantity;
                saveCart();
                renderCart();
            }
        }
        
        // Удаление из корзины
        function removeFromCart(productId) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                const removedItem = cart[itemIndex];
                cart.splice(itemIndex, 1);
                saveCart();
                renderCart();
                showAlert(`"${removedItem.name}" удален из корзины`, 'info');
            }
        }
        
        // Сохранение корзины
        function saveCart() {
            localStorage.setItem('divers_cart', JSON.stringify(cart));
        }
        
        // Получение товаров по умолчанию
        function getDefaultProducts() {
            localStorage.setItem('divers_products', JSON.stringify(products));
            return products;
        }
        
        // Сохранение нового товара
        function saveProduct() {
            const name = document.getElementById('new-product-name').value;
            const category = document.getElementById('new-product-category').value;
            const description = document.getElementById('new-product-description').value;
            const price = parseFloat(document.getElementById('new-product-price').value);
            const image = document.getElementById('new-product-image').value;
            
            // Сбор особенностей
            const featureInputs = document.querySelectorAll('.feature-input');
            const features = Array.from(featureInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
            
            if (!name || !description || !price || !image) {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }
            
            if (price <= 0) {
                showAlert('Цена должна быть больше 0!', 'danger');
                return;
            }
            
            const currentProducts = JSON.parse(localStorage.getItem('divers_products')) || getDefaultProducts();
            
            // Генерация нового ID
            const newId = currentProducts.length > 0 ? Math.max(...currentProducts.map(p => p.id)) + 1 : 1;
            
            const newProduct = {
                id: newId,
                name,
                category,
                description,
                price: parseFloat(price.toFixed(2)),
                image,
                features
            };
            
            currentProducts.push(newProduct);
            localStorage.setItem('divers_products', JSON.stringify(currentProducts));
            
            // Закрытие модального окна
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            
            // Очистка формы
            document.getElementById('add-product-form').reset();
            document.getElementById('features-container').innerHTML = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control feature-input" placeholder="Особенность товара">
                    <button class="btn btn-outline-danger" type="button" onclick="removeFeature(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Обновление интерфейса
            renderProducts();
            loadQuickProducts();
            showAlert('Товар успешно добавлен!', 'success');
        }
        
        // Добавление поля особенности
        function addFeatureField() {
            const container = document.getElementById('features-container');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" class="form-control feature-input" placeholder="Особенность товара">
                <button class="btn btn-outline-danger" type="button" onclick="removeFeature(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        }
        
        // Добавление поля особенности в редакторе
        function addEditFeatureField() {
            const container = document.getElementById('edit-features-container');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" class="form-control edit-feature-input" placeholder="Особенность товара">
                <button class="btn btn-outline-danger" type="button" onclick="removeEditFeature(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        }
        
        // Удаление поля особенности
        function removeFeature(button) {
            button.closest('.input-group').remove();
        }
        
        // Удаление поля особенности в редакторе
        function removeEditFeature(button) {
            button.closest('.input-group').remove();
        }
        
        // Редактирование товара
        function editProduct(productId) {
            const currentProducts = JSON.parse(localStorage.getItem('divers_products')) || getDefaultProducts();
            const product = currentProducts.find(p => p.id === productId);
            
            if (!product) return;
            
            // Заполнение формы
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-category').value = product.category;
            document.getElementById('edit-product-description').value = product.description;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-image').value = product.image;
            
            // Очистка контейнера особенностей
            const featuresContainer = document.getElementById('edit-features-container');
            featuresContainer.innerHTML = '';
            
            // Добавление особенностей
            if (product.features && product.features.length > 0) {
                product.features.forEach(feature => {
                    const div = document.createElement('div');
                    div.className = 'input-group mb-2';
                    div.innerHTML = `
                        <input type="text" class="form-control edit-feature-input" value="${feature}">
                        <button class="btn btn-outline-danger" type="button" onclick="removeEditFeature(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    featuresContainer.appendChild(div);
                });
            } else {
                const div = document.createElement('div');
                div.className = 'input-group mb-2';
                div.innerHTML = `
                    <input type="text" class="form-control edit-feature-input" placeholder="Особенность товара">
                    <button class="btn btn-outline-danger" type="button" onclick="removeEditFeature(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                featuresContainer.appendChild(div);
            }
            
            // Показать модальное окно
            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
        }
        
        // Обновление товара
        function updateProduct() {
            const productId = parseInt(document.getElementById('edit-product-id').value);
            const name = document.getElementById('edit-product-name').value;
            const category = document.getElementById('edit-product-category').value;
            const description = document.getElementById('edit-product-description').value;
            const price = parseFloat(document.getElementById('edit-product-price').value);
            const image = document.getElementById('edit-product-image').value;
            
            // Сбор особенностей
            const featureInputs = document.querySelectorAll('.edit-feature-input');
            const features = Array.from(featureInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
            
            if (!name || !description || !price || !image) {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }
            
            if (price <= 0) {
                showAlert('Цена должна быть больше 0!', 'danger');
                return;
            }
            
            const currentProducts = JSON.parse(localStorage.getItem('divers_products')) || getDefaultProducts();
            const productIndex = currentProducts.findIndex(p => p.id === productId);
            
            if (productIndex === -1) {
                showAlert('Товар не найден!', 'danger');
                return;
            }
            
            // Обновление товара
            currentProducts[productIndex] = {
                ...currentProducts[productIndex],
                name,
                category,
                description,
                price: parseFloat(price.toFixed(2)),
                image,
                features
            };
            
            localStorage.setItem('divers_products', JSON.stringify(currentProducts));
            
            // Закрытие модального окна
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
            modal.hide();
            
            // Обновление интерфейса
            renderProducts();
            loadQuickProducts();
            showAlert('Товар успешно обновлен!', 'success');
        }
        
        // Удаление товара
        function deleteProduct(productId) {
            const currentProducts = JSON.parse(localStorage.getItem('divers_products')) || getDefaultProducts();
            const productIndex = currentProducts.findIndex(p => p.id === productId);
            
            if (productIndex === -1) return;
            
            const productName = currentProducts[productIndex].name;
            currentProducts.splice(productIndex, 1);
            localStorage.setItem('divers_products', JSON.stringify(currentProducts));
            
            // Обновление интерфейса
            renderProducts();
            loadQuickProducts();
            showAlert(`Товар "${productName}" удален!`, 'success');
        }
        
        // Загрузка всех товаров (для админ-панели)
        function loadAllProducts() {
            const currentProducts = JSON.parse(localStorage.getItem('divers_products')) || getDefaultProducts();
            loadQuickProducts();
            showAlert(`Загружено ${currentProducts.length} товаров`, 'info');
        }
        
        // Экспорт товаров
        function exportProducts() {
            const currentProducts = JSON.parse(localStorage.getItem('divers_products')) || getDefaultProducts();
            
            // Создаем CSV содержимое
            let csvContent = "ID,Название,Категория,Описание,Цена,Изображение,Особенности\n";
            
            currentProducts.forEach(product => {
                const features = product.features ? product.features.join('; ') : '';
                const row = [
                    product.id,
                    `"${product.name}"`,
                    product.category,
                    `"${product.description}"`,
                    product.price,
                    product.image,
                    `"${features}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Создаем Blob и скачиваем файл
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `divers_products_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert(`Экспортировано ${currentProducts.length} товаров`, 'success');
        }
        
        // Вспомогательные функции
        function getCategoryName(category) {
            const categories = {
                'armor': 'Броня',
                'weapons': 'Оружие',
                'medicine': 'Медицина',
                'attachments': 'Встройки',
                'ammo': 'Патроны',
                'throwable': 'Метательное'
            };
            return categories[category] || category;
        }
        
        function getCategoryColor(category) {
            const categoryColors = {
                'armor': '#3498db',
                'weapons': '#e74c3c',
                'medicine': '#2ecc71',
                'attachments': '#9b59b6',
                'ammo': '#f39c12',
                'throwable': '#1abc9c'
            };
            return categoryColors[category] || '#666';
        }
        
        function getStatusText(status) {
            const statuses = {
                'pending': 'Ожидает обработки',
                'completed': 'Выдан',
                'cancelled': 'Отменен',
                'test': 'Тестовый'
            };
            return statuses[status] || status;
        }
        
        function getStatusClass(status) {
            const classes = {
                'pending': 'status-pending',
                'completed': 'status-completed',
                'cancelled': 'status-cancelled',
                'test': 'status-pending'
            };
            return classes[status] || '';
        }
        
        function getStatusEmoji(status) {
            const emojis = {
                'pending': '⏳',
                'completed': '✅',
                'cancelled': '❌',
                'test': '🧪'
            };
            return emojis[status] || '📝';
        }
        
        // Функция показа уведомлений
        function showAlert(message, type = 'info') {
            // Удаляем предыдущие уведомления
            document.querySelectorAll('.alert').forEach(alert => {
                if (alert.parentNode) alert.parentNode.removeChild(alert);
            });
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.content-wrapper').appendChild(alertDiv);
            
            // Автоматическое скрытие через 5 секунд
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Инициализация при загрузке
        window.addEventListener('load', function() {
            // Загружаем товары из localStorage или используем дефолтные
            const storedProducts = localStorage.getItem('divers_products');
            if (!storedProducts) {
                localStorage.setItem('divers_products', JSON.stringify(products));
            }
            
            // Обновляем счетчики
            updateNotificationBadge();
            updateOrdersCount();
            
            // Загружаем настройки Telegram
            loadTelegramSettings();
            
            // Показываем приветственное сообщение
            if (!localStorage.getItem('divers_welcome_shown')) {
                setTimeout(() => {
                    showAlert('Добро пожаловать в магазин DiverS! Выберите товары и добавьте их в корзину.', 'info');
                    localStorage.setItem('divers_welcome_shown', 'true');
                }, 1000);
            }
        });
        
        // Обработка клавиш для админ-панели
        document.addEventListener('keydown', function(e) {
            // Ctrl+Alt+A для открытия админ-панели
            if (e.ctrlKey && e.altKey && e.key === 'a') {
                e.preventDefault();
                openAdminPanel();
            }
            
            // Escape для закрытия админ-панели
            if (e.key === 'Escape') {
                closeAdminPanel();
            }
        });
        
        // Сохранение состояния при закрытии вкладки
        window.addEventListener('beforeunload', function() {
            // Сохраняем текущую корзину
            saveCart();
            
            // Сохраняем историю заказов
            localStorage.setItem('divers_orders', JSON.stringify(orderHistory));
        });
        
        // Периодическая проверка новых заказов
        setInterval(function() {
            const oldCount = notificationCount;
            notificationCount = orderHistory.filter(order => order.status === 'pending').length;
            
            if (notificationCount > oldCount) {
                updateNotificationBadge();
                showAlert(`Поступил новый заказ! Всего ожидает обработки: ${notificationCount}`, 'info');
            }
        }, 30000); // Проверка каждые 30 секунд
    </script>
	<!-- Вставьте этот скрипт в конец вашего HTML, перед закрывающим тегом </body> -->
<script>
    // URL для Netlify функций
    const API_BASE_URL = '/.netlify/functions';
    
    // Функции для работы с API
    async function apiRequest(endpoint, method = 'GET', data = null) {
        try {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            return { success: false, error: error.message };
        }
    }
    
    // Загрузка товаров с сервера
    async function loadProductsFromServer() {
        try {
            const response = await apiRequest('/products');
            if (response.success) {
                return response.data;
            }
            return getDefaultProducts();
        } catch (error) {
            console.error('Failed to load products:', error);
            return getDefaultProducts();
        }
    }
    
    // Сохранение товаров на сервер
    async function saveProductsToServer(products) {
        try {
            const response = await apiRequest('/products', 'POST', { products });
            return response.success;
        } catch (error) {
            console.error('Failed to save products:', error);
            return false;
        }
    }
    
    // Сохранение заказа на сервер
    async function saveOrderToServer(order) {
        try {
            const response = await apiRequest('/orders', 'POST', order);
            return response.success;
        } catch (error) {
            console.error('Failed to save order:', error);
            return false;
        }
    }
    
    // Загрузка заказов с сервера
    async function loadOrdersFromServer() {
        try {
            const response = await apiRequest('/orders');
            if (response.success) {
                return response.data;
            }
            return [];
        } catch (error) {
            console.error('Failed to load orders:', error);
            return [];
        }
    }
    
    // Сохранение настроек Telegram
    async function saveTelegramSettings(settings) {
        try {
            const response = await apiRequest('/telegram', 'POST', settings);
            return response.success;
        } catch (error) {
            console.error('Failed to save Telegram settings:', error);
            return false;
        }
    }
    
    // Загрузка настроек Telegram
    async function loadTelegramSettings() {
        try {
            const response = await apiRequest('/telegram');
            if (response.success) {
                return response.data;
            }
            return DEFAULT_TELEGRAM_SETTINGS;
        } catch (error) {
            console.error('Failed to load Telegram settings:', error);
            return DEFAULT_TELEGRAM_SETTINGS;
        }
    }
    
    // Отправка уведомления в Telegram
    async function sendTelegramNotification(order) {
        try {
            const response = await apiRequest('/telegram/send', 'POST', { order });
            return response;
        } catch (error) {
            console.error('Failed to send Telegram notification:', error);
            return { success: false, error: error.message };
        }
    }
    
    // Обновить ваши существующие функции для работы с API
    async function processOrder(nickname) {
        // ... существующий код ...
        
        // Вместо localStorage сохраняем на сервер
        const saved = await saveOrderToServer(order);
        if (saved) {
            // Отправляем уведомление
            const telegramResult = await sendTelegramNotification(order);
            // ... остальной код ...
        }
    }
    
    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', async function() {
        // Загружаем данные с сервера
        const [serverProducts, serverOrders, telegramSettings] = await Promise.all([
            loadProductsFromServer(),
            loadOrdersFromServer(),
            loadTelegramSettings()
        ]);
        
        // Используем данные с сервера или локальные
        if (serverProducts && serverProducts.length > 0) {
            localStorage.setItem('divers_products', JSON.stringify(serverProducts));
        }
        
        if (serverOrders && serverOrders.length > 0) {
            orderHistory = serverOrders;
            localStorage.setItem('divers_orders', JSON.stringify(serverOrders));
        }
        
        if (telegramSettings) {
            localStorage.setItem('divers_telegram_settings', JSON.stringify(telegramSettings));
        }
        
        // Запускаем остальную инициализацию
        renderProducts();
        renderCart();
        // ... остальной код ...
    });
</script>
</body>
</html>
